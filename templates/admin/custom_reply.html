{% extends "admin/layout.html" %}

{% block page_title %}è‡ªå®šä¹‰å›å¤{% endblock %}

{% block page_content %}
<style>
    /* å­—æ®µæ ·å¼è§„èŒƒ */
    .field-label {
        @apply text-xs font-semibold text-gray-600 uppercase tracking-wider;
    }
    .field-value {
        @apply text-sm text-gray-900 font-medium;
    }
    .field-box {
        @apply p-3 rounded-lg border border-gray-200 bg-gray-50;
    }
    .field-box.highlight {
        @apply border-blue-200 bg-blue-50;
    }
    .field-box.success {
        @apply border-green-200 bg-green-50;
    }
    .field-box.error {
        @apply border-red-200 bg-red-50;
    }
    .method-badge {
        @apply px-2 py-1 rounded text-xs font-semibold;
    }
    .method-badge.get {
        @apply bg-blue-100 text-blue-800;
    }
    .method-badge.post {
        @apply bg-green-100 text-green-800;
    }
    .method-badge.put {
        @apply bg-yellow-100 text-yellow-800;
    }
    .method-badge.delete {
        @apply bg-red-100 text-red-800;
    }
    .api-path {
        @apply font-mono text-xs text-gray-700 bg-gray-100 px-2 py-1 rounded;
    }
    .field-row {
        @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4;
    }
</style>

<div class="space-y-6" x-data="customReplyData()">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="fade-in">
        <h1 class="text-2xl font-bold text-gray-800">è‡ªå®šä¹‰å›å¤</h1>
        <p class="text-gray-500 mt-1">é…ç½®å…³é”®è¯åŒ¹é…å’Œè‡ªåŠ¨å›å¤è§„åˆ™</p>
    </div>
    
    <!-- æ“ä½œæ  -->
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 fade-in">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                    <i class="fas fa-search"></i>
                </span>
                <input
                    type="text"
                    x-model="searchTerm"
                    @input="filterReplies()"
                    placeholder="æœç´¢å…³é”®è¯..."
                    class="block w-full md:w-72 pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                />
            </div>
            
            <button 
                @click="showAddModal = true"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 flex items-center">
                <i class="fas fa-plus mr-2"></i>æ·»åŠ å›å¤è§„åˆ™
            </button>
        </div>
    </div>
    
    <!-- å›å¤è§„åˆ™è¡¨æ ¼ -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 fade-in">
        <template x-if="loading">
            <div class="p-12 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                <p class="mt-4 text-gray-500">åŠ è½½ä¸­...</p>
            </div>
        </template>
        
        <template x-if="!loading && filteredReplies.length === 0">
            <div class="p-12 text-center">
                <div class="text-6xl mb-4 text-blue-300">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <p class="text-lg text-gray-500">æš‚æ— å›å¤è§„åˆ™</p>
                <button 
                    @click="showAddModal = true"
                    class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center mx-auto">
                    <i class="fas fa-plus mr-2"></i>æ·»åŠ å›å¤è§„åˆ™
                </button>
            </div>
        </template>
        
        <template x-if="!loading && filteredReplies.length > 0">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-key mr-2"></i>å…³é”®è¯
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-search mr-2"></i>åŒ¹é…æ–¹å¼
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-reply mr-2"></i>å›å¤ç±»å‹ & å†…å®¹
                            </th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-arrow-up mr-2"></i>ä¼˜å…ˆçº§
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-toggle-on mr-2"></i>çŠ¶æ€
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="reply in filteredReplies" :key="reply.id">
                            <tr class="hover:bg-gray-50 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold" x-text="reply.keyword"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span class="method-badge" :class="reply.match_type === 'exact' ? 'post' : 'put'" x-text="reply.match_type === 'exact' ? 'ç²¾ç¡®åŒ¹é…' : 'åŒ…å«åŒ¹é…'"></span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900">
                                    <div class="flex items-center gap-2">
                                        <span :class="reply.reply_type === 'text' ? 'bg-green-100 text-green-800' : reply.reply_type === 'image' ? 'bg-purple-100 text-purple-800' : 'bg-cyan-100 text-cyan-800'" class="px-2 py-1 rounded text-xs font-medium" :x-text="reply.reply_type === 'text' ? 'æ–‡æœ¬' : reply.reply_type === 'image' ? 'å›¾ç‰‡' : 'å›¾æ–‡'"></span>
                                        <span class="max-w-xs truncate text-gray-700" x-text="reply.reply_type === 'news' ? (function() { try { const data = JSON.parse(reply.reply_content); return data.title || '(æ— æ ‡é¢˜)'; } catch(e) { return '(æ ¼å¼é”™è¯¯)'; } })() : reply.reply_content"></span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full font-semibold text-sm" x-text="reply.priority"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="reply.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" x-text="reply.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex justify-end space-x-2">
                                        <button 
                                            @click="editReply(reply)"
                                            class="text-blue-600 hover:text-blue-900 transition-colors duration-200 p-1"
                                            title="ç¼–è¾‘">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button 
                                            @click="toggleReply(reply.id)"
                                            class="text-purple-600 hover:text-purple-900 transition-colors duration-200 p-1"
                                            title="åˆ‡æ¢çŠ¶æ€">
                                            <i class="fas fa-toggle-on"></i>
                                        </button>
                                        <button 
                                            @click="deleteReply(reply.id)"
                                            class="text-red-600 hover:text-red-900 transition-colors duration-200 p-1"
                                            title="åˆ é™¤">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
    <template x-if="showAddModal">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" @click.self="showAddModal = false">
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl">
                <h3 class="text-lg font-semibold mb-4 text-gray-800" x-text="formData.id ? 'ç¼–è¾‘å›å¤è§„åˆ™' : 'æ·»åŠ å›å¤è§„åˆ™'"></h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å…³é”®è¯</label>
                        <input 
                            type="text" 
                            x-model="formData.keyword"
                            placeholder="è¾“å…¥å…³é”®è¯"
                            class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                        />
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åŒ¹é…æ–¹å¼</label>
                            <select 
                                x-model="formData.match_type"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                                <option value="exact">ç²¾ç¡®åŒ¹é…</option>
                                <option value="contains">åŒ…å«åŒ¹é…</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å›å¤ç±»å‹</label>
                            <select 
                                x-model="formData.reply_type"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                                <option value="text">æ–‡æœ¬</option>
                                <option value="image">å›¾ç‰‡</option>
                                <option value="news">å›¾æ–‡</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¼˜å…ˆçº§</label>
                            <input 
                                type="number" 
                                x-model.number="formData.priority"
                                min="0"
                                max="100"
                                placeholder="0-100ï¼Œè¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                            />
                            <small class="text-gray-500 mt-1">é»˜è®¤å€¼ï¼š50</small>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å›å¤å†…å®¹</label>
                        <template x-if="formData.reply_type === 'news'">
                            <div class="space-y-4">
                                <!-- æ ‡é¢˜ -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">
                                        <span class="text-red-500">*</span> æ–‡ç« æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰
                                    </label>
                                    <input 
                                        type="text" 
                                        x-model="formData.news_title"
                                        placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜ï¼Œå¦‚ï¼šå¾®ä¿¡å¼€å‘æœ€ä½³å®è·µ"
                                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    />
                                </div>
                                
                                <!-- æè¿° -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">
                                        æ–‡ç« æè¿°/æ‘˜è¦ï¼ˆå¯é€‰ï¼‰
                                    </label>
                                    <textarea 
                                        x-model="formData.news_description"
                                        placeholder="è¾“å…¥æ–‡ç« æ‘˜è¦æˆ–ç®€çŸ­æè¿°ï¼Œå¦‚ï¼šå­¦ä¹ å¦‚ä½•å¼€å‘ä¼˜ç§€çš„å¾®ä¿¡åº”ç”¨"
                                        rows="2"
                                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"></textarea>
                                </div>
                                
                                <!-- ç¼©ç•¥å›¾URL -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">
                                        ç¼©ç•¥å›¾URLï¼ˆå¯é€‰ï¼‰
                                    </label>
                                    <input 
                                        type="text" 
                                        x-model="formData.news_picUrl"
                                        placeholder="è¾“å…¥å›¾ç‰‡URLï¼Œå¦‚ï¼šhttps://example.com/image.jpg"
                                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    />
                                    <p class="text-xs text-gray-500 mt-1">ğŸ’¡ æ”¯æŒHTTPSçš„å…¬ç½‘å›¾ç‰‡é“¾æ¥</p>
                                </div>
                                
                                <!-- è·³è½¬é“¾æ¥ -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">
                                        ç‚¹å‡»åè·³è½¬çš„é“¾æ¥ï¼ˆå¯é€‰ï¼‰
                                    </label>
                                    <input 
                                        type="text" 
                                        x-model="formData.news_url"
                                        placeholder="è¾“å…¥ç‚¹å‡»å›¾æ–‡åè·³è½¬çš„ç½‘å€ï¼Œå¦‚ï¼šhttps://example.com/article/123"
                                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                    />
                                    <p class="text-xs text-gray-500 mt-1">ğŸ’¡ å¯ä»¥æ˜¯å¤–éƒ¨ç½‘å€æˆ–å°ç¨‹åºé“¾æ¥</p>
                                </div>
                                
                                <!-- é¢„è§ˆ -->
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                    <p class="text-xs font-semibold text-gray-600 mb-2">ğŸ“± å¾®ä¿¡é¢„è§ˆæ•ˆæœï¼š</p>
                                    <div class="bg-white border border-gray-300 rounded p-2 text-xs">
                                        <p class="font-semibold text-gray-800 truncate" x-text="formData.news_title || '(è¾“å…¥æ ‡é¢˜åæ˜¾ç¤º)'"></p>
                                        <p class="text-gray-600 text-xs mt-1 line-clamp-2" x-text="formData.news_description || '(è¾“å…¥æè¿°åæ˜¾ç¤º)'"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template x-if="formData.reply_type !== 'news'">
                            <textarea 
                                x-model="formData.reply_content"
                                placeholder="è¾“å…¥å›å¤å†…å®¹"
                                rows="4"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"></textarea>
                        </template>
                    </div>
                    
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            x-model="formData.enabled"
                            id="enableToggle"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        />
                        <label for="enableToggle" class="ml-2 block text-sm text-gray-700">å¯ç”¨æ­¤è§„åˆ™</label>
                    </div>
                    
                    <div class="pt-4 flex justify-end space-x-3">
                        <button 
                            @click="showAddModal = false"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200">
                            å–æ¶ˆ
                        </button>
                        <button 
                            @click="saveReply()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200"
                            x-text="formData.id ? 'æ›´æ–°' : 'ä¿å­˜'"></button>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
function customReplyData() {
    return {
        replies: [],
        filteredReplies: [],
        searchTerm: '',
        loading: true,
        showAddModal: false,
        formData: {
            keyword: '',
            match_type: 'exact',
            reply_type: 'text',
            reply_content: '',
            priority: 50,
            enabled: true,
            news_title: '',
            news_description: '',
            news_picUrl: '',
            news_url: ''
        },
        
        async loadReplies() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/replies?t=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, max-age=0'
                    }
                });
                this.replies = await response.json();
                this.filterReplies();
                this.loading = false;
            } catch (error) {
                console.error('åŠ è½½å›å¤è§„åˆ™å¤±è´¥:', error);
                window.showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                this.loading = false;
            }
        },
        
        filterReplies() {
            this.filteredReplies = this.replies.filter(reply => 
                reply.keyword.includes(this.searchTerm) || 
                reply.reply_content.includes(this.searchTerm)
            );
        },
        
        async saveReply() {
            if (!this.formData.keyword) {
                window.showToast('è¯·å¡«å†™å…³é”®è¯', 'error');
                return;
            }
            
            // å›¾æ–‡æ¶ˆæ¯éªŒè¯
            if (this.formData.reply_type === 'news') {
                if (!this.formData.news_title) {
                    window.showToast('è¯·å¡«å†™æ–‡ç« æ ‡é¢˜', 'error');
                    return;
                }
                // å°†å›¾æ–‡å­—æ®µç»„è£…æˆJSON
                const newsData = {
                    title: this.formData.news_title,
                    description: this.formData.news_description || '',
                    picUrl: this.formData.news_picUrl || '',
                    url: this.formData.news_url || ''
                };
                this.formData.reply_content = JSON.stringify(newsData, null, 2);
            } else {
                if (!this.formData.reply_content) {
                    window.showToast('è¯·å¡«å†™å›å¤å†…å®¹', 'error');
                    return;
                }
            }
            
            try {
                const payload = {
                    id: this.formData.id,
                    keyword: this.formData.keyword,
                    matchType: this.formData.match_type,
                    replyType: this.formData.reply_type,
                    replyContent: this.formData.reply_content,
                    priority: this.formData.priority,
                    enabled: this.formData.enabled
                };
                
                const response = await fetch('/api/replies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                
                if (result && result.success === true) {
                    window.showToast('è§„åˆ™å·²ä¿å­˜', 'success');
                    this.showAddModal = false;
                    console.log('[DEBUG] saveReply success, reloading...');
                    setTimeout(() => window.location.reload(true), 800);
                } else {
                    window.showToast(result?.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                window.showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        },
        
        deleteReply(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
                fetch(`/api/replies/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    window.showToast('è§„åˆ™å·²åˆ é™¤', 'success');
                    console.log('[DEBUG] deleteReply success, reloading...');
                    setTimeout(() => window.location.reload(true), 800);
                })
                .catch(error => {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    window.showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                });
            }
        },
        
        toggleReply(id) {
            fetch(`/api/replies/${id}/toggle`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                window.showToast('çŠ¶æ€å·²æ›´æ–°', 'success');
                console.log('[DEBUG] toggleReply success, reloading...');
                setTimeout(() => window.location.reload(true), 800);
            })
            .catch(error => {
                console.error('æ›´æ–°å¤±è´¥:', error);
                window.showToast('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        },
        
        editReply(reply) {
            this.formData = { ...reply };
            // å¦‚æœæ˜¯å›¾æ–‡æ¶ˆæ¯ï¼Œè§£æJSONåˆ°å„ä¸ªå­—æ®µ
            if (reply.reply_type === 'news') {
                try {
                    const newsData = JSON.parse(reply.reply_content);
                    this.formData.news_title = newsData.title || '';
                    this.formData.news_description = newsData.description || '';
                    this.formData.news_picUrl = newsData.picUrl || '';
                    this.formData.news_url = newsData.url || '';
                } catch (e) {
                    console.error('è§£æå›¾æ–‡æ•°æ®å¤±è´¥:', e);
                }
            }
            this.showAddModal = true;
        },
        
        resetForm() {
            this.formData = {
                keyword: '',
                match_type: 'exact',
                reply_type: 'text',
                reply_content: '',
                priority: 50,
                enabled: true,
                news_title: '',
                news_description: '',
                news_picUrl: '',
                news_url: ''
            };
        },
        
        init() {
            this.loadReplies();
        }
    }
}
</script>
{% endblock %}